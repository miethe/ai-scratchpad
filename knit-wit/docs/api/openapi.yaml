openapi: 3.0.3
info:
  title: Knit-Wit API
  description: |
    REST API for parametric crochet pattern generation and export.

    ## Features
    - Pattern generation for geometric shapes (sphere, cylinder, cone)
    - Multi-format exports (PDF, SVG, JSON DSL)
    - RESTful design with standard HTTP methods
    - Stateless, session-based patterns (MVP)
    - Comprehensive error handling

    ## Getting Started
    - Base URL: `/api/v1` (e.g., `http://localhost:8000/api/v1`)
    - Health check: `GET /health`
    - Interactive docs: `GET /docs` (Swagger UI)

    ## Authentication
    Not required for MVP. Will be added in v1.1.

    ## Error Handling
    All errors follow a standardized format with error codes and details.
    See the Responses section for examples.
  version: 0.1.0
  contact:
    name: Knit-Wit Team
    url: https://github.com/knit-wit
    email: dev@knit-wit.example.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8000/api/v1
    description: Local development server
    variables:
      port:
        default: '8000'
  - url: https://api.knit-wit.app/api/v1
    description: Production server (future)

paths:
  /patterns/generate:
    post:
      summary: Generate a crochet pattern
      description: |
        Generates a complete crochet pattern (DSL) for the specified shape with parameters.

        The pattern is stored in session cache and expires after 2 hours.
        Use the returned pattern ID to retrieve or export the pattern.
      operationId: generatePattern
      tags:
        - Patterns
      requestBody:
        required: true
        description: Pattern generation parameters
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GeneratePatternRequest'
            examples:
              sphere:
                summary: Generate 10cm sphere
                value:
                  shape:
                    shape_type: sphere
                    diameter_cm: 10.0
                  gauge:
                    stitches_per_cm: 1.4
                    rows_per_cm: 1.6
                    hook_size_mm: 4.0
                    yarn_weight: worsted
                  terminology: US
              cylinder:
                summary: Generate 8cm x 12cm cylinder
                value:
                  shape:
                    shape_type: cylinder
                    diameter_cm: 8.0
                    height_cm: 12.0
                  gauge:
                    stitches_per_cm: 1.5
                    rows_per_cm: 1.7
              cone:
                summary: Generate tapered cone
                value:
                  shape:
                    shape_type: cone
                    base_diameter_cm: 12.0
                    top_diameter_cm: 4.0
                    height_cm: 15.0
                  gauge:
                    stitches_per_cm: 1.6
                    rows_per_cm: 1.8

      responses:
        '201':
          description: Pattern successfully generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GeneratePatternResponse'
              example:
                success: true
                data:
                  id: pattern_8f7a3b9c-2e1d-4k6j-9x2p-5q8r1s3t2u9v
                  pattern:
                    shape:
                      shape_type: sphere
                      diameter_cm: 10.0
                    gauge:
                      stitches_per_cm: 1.4
                      rows_per_cm: 1.6
                      hook_size_mm: 4.0
                      yarn_weight: worsted
                    rounds:
                      - round_number: 0
                        stitches:
                          - stitch_type: ch
                            count: 2
                            target: null
                            note: Magic ring alternative
                          - stitch_type: sc
                            count: 6
                            target: second ch from hook
                            note: null
                        total_stitches: 6
                        description: Start with magic ring, 6 sc
                      - round_number: 1
                        stitches:
                          - stitch_type: inc
                            count: 6
                            target: each st
                            note: 2 sc in each stitch around
                        total_stitches: 12
                        description: Increase round - 2 sc in each st (12)
                    metadata:
                      generated_at: '2024-11-10T12:34:56Z'
                      engine_version: 0.1.0
                      total_rounds: 8
                      estimated_time_minutes: 45
                      difficulty: beginner
                      tags:
                        - sphere
                        - 3d-shape
                        - amigurumi
                        - beginner-friendly
                    notes: Work in continuous spiral. Use stitch marker.
                  created_at: '2024-11-10T12:34:56Z'
                  expires_at: '2024-11-10T14:34:56Z'
                meta:
                  version: 0.1.0
                  timestamp: '2024-11-10T12:34:56Z'
                  request_id: req_abc123xyz

        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                validation_error:
                  summary: Validation error
                  value:
                    success: false
                    error:
                      code: VALIDATION_ERROR
                      message: Invalid request data
                      details:
                        field: shape.diameter_cm
                        constraint: must be > 0
                        provided: -5
                    meta:
                      version: 0.1.0
                      timestamp: '2024-11-10T12:34:56Z'
                      request_id: req_abc123xyz
                invalid_gauge:
                  summary: Invalid gauge parameters
                  value:
                    success: false
                    error:
                      code: INVALID_GAUGE
                      message: Invalid gauge parameters
                      details:
                        field: gauge.stitches_per_cm
                        constraint: must be between 0.5 and 20
                        provided: 0.1
                    meta:
                      version: 0.1.0
                      timestamp: '2024-11-10T12:34:56Z'
                      request_id: req_abc123xyz

        '500':
          description: Server error during pattern generation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: GENERATION_ERROR
                  message: Failed to generate pattern
                  details:
                    reason: gauge distribution calculation exceeded limits
                meta:
                  version: 0.1.0
                  timestamp: '2024-11-10T12:34:56Z'
                  request_id: req_abc123xyz

  /patterns/{patternId}:
    get:
      summary: Retrieve a previously generated pattern
      description: Returns a pattern from session cache by ID. Pattern must be retrieved before session expires.
      operationId: getPattern
      tags:
        - Patterns
      parameters:
        - name: patternId
          in: path
          required: true
          description: Pattern identifier (UUID)
          schema:
            type: string
            format: uuid
          example: pattern_8f7a3b9c-2e1d-4k6j-9x2p-5q8r1s3t2u9v

      responses:
        '200':
          description: Pattern retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetPatternResponse'

        '404':
          description: Pattern not found or expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: PATTERN_NOT_FOUND
                  message: Pattern not found
                  details:
                    pattern_id: pattern_invalid_id
                    reason: pattern expired or does not exist
                meta:
                  version: 0.1.0
                  timestamp: '2024-11-10T12:34:56Z'
                  request_id: req_abc123xyz

  /patterns/{patternId}/export/pdf:
    post:
      summary: Export pattern to PDF
      description: |
        Generates a PDF document of the pattern with instructions, diagram, and materials list.

        Returns base64-encoded PDF content or external URL depending on deployment.
      operationId: exportPatternPdf
      tags:
        - Exports
      parameters:
        - name: patternId
          in: path
          required: true
          description: Pattern identifier (UUID)
          schema:
            type: string
            format: uuid

      requestBody:
        description: Export options (optional)
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PdfExportOptions'

      responses:
        '200':
          description: PDF exported successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExportResponse'

        '404':
          description: Pattern not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

        '500':
          description: PDF generation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: EXPORT_ERROR
                  message: Failed to export pattern
                  details:
                    format: pdf
                    reason: PDF rendering service unavailable
                meta:
                  version: 0.1.0
                  timestamp: '2024-11-10T12:34:56Z'
                  request_id: req_abc123xyz

  /patterns/{patternId}/export/svg:
    post:
      summary: Export pattern to SVG
      description: |
        Generates an SVG visualization of the pattern structure.

        Returns SVG XML content that can be embedded in HTML or saved to file.
      operationId: exportPatternSvg
      tags:
        - Exports
      parameters:
        - name: patternId
          in: path
          required: true
          description: Pattern identifier (UUID)
          schema:
            type: string
            format: uuid

      requestBody:
        description: Export options (optional)
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SvgExportOptions'

      responses:
        '200':
          description: SVG exported successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExportResponse'

        '404':
          description: Pattern not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

        '500':
          description: SVG generation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /health:
    get:
      summary: Health check endpoint
      description: Returns the health status of the API. Not version-gated (at root level).
      operationId: healthCheck
      tags:
        - Health
      responses:
        '200':
          description: API is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: healthy
                version: 0.1.0
                app_name: Knit-Wit API
                timestamp: '2024-11-10T12:34:56Z'
                components:
                  pattern_engine: healthy
                  export_service: healthy

components:
  schemas:
    # Request Schemas
    GeneratePatternRequest:
      type: object
      required:
        - shape
        - gauge
      properties:
        shape:
          $ref: '#/components/schemas/ShapeParameters'
        gauge:
          $ref: '#/components/schemas/GaugeInfo'
        stitch_type:
          type: string
          default: sc
          description: Stitch type (only 'sc' supported in MVP)
          enum:
            - sc
        terminology:
          type: string
          default: US
          description: Crochet terminology preference
          enum:
            - US
            - UK
        units:
          type: string
          default: cm
          description: Unit of measurement
          enum:
            - cm
            - inches
        notes:
          type: string
          maxLength: 500
          description: Additional notes or instructions
          nullable: true

    ShapeParameters:
      type: object
      required:
        - shape_type
      properties:
        shape_type:
          type: string
          enum:
            - sphere
            - cylinder
            - cone
          description: Type of 3D shape
        diameter_cm:
          type: number
          exclusiveMinimum: 0
          maximum: 100
          description: Diameter in centimeters (sphere, cylinder)
          nullable: true
        height_cm:
          type: number
          exclusiveMinimum: 0
          maximum: 100
          description: Height in centimeters (cylinder, cone)
          nullable: true
        base_diameter_cm:
          type: number
          exclusiveMinimum: 0
          maximum: 100
          description: Base diameter in centimeters (cone)
          nullable: true
        top_diameter_cm:
          type: number
          exclusiveMinimum: 0
          maximum: 100
          description: Top diameter in centimeters (cone)
          nullable: true

    GaugeInfo:
      type: object
      required:
        - stitches_per_cm
        - rows_per_cm
      properties:
        stitches_per_cm:
          type: number
          exclusiveMinimum: 0.5
          maximum: 20
          description: Stitches per centimeter
        rows_per_cm:
          type: number
          exclusiveMinimum: 0.5
          maximum: 20
          description: Rows per centimeter
        hook_size_mm:
          type: number
          exclusiveMinimum: 0
          description: Hook size in millimeters
          nullable: true
        yarn_weight:
          type: string
          enum:
            - lace
            - fingering
            - sport
            - DK
            - worsted
            - bulky
            - super_bulky
          description: Yarn weight category
          nullable: true
        swatch_notes:
          type: string
          description: Notes about gauge swatch
          nullable: true

    PdfExportOptions:
      type: object
      properties:
        options:
          type: object
          properties:
            include_diagram:
              type: boolean
              default: true
              description: Include visual diagram
            include_materials:
              type: boolean
              default: true
              description: Include materials list
            include_gauge_swatch:
              type: boolean
              default: true
              description: Include gauge swatch info
            paper_size:
              type: string
              enum:
                - A4
                - Letter
              default: A4
              description: PDF paper size
            include_difficulty:
              type: boolean
              default: true
              description: Include difficulty level
            include_time_estimate:
              type: boolean
              default: true
              description: Include time estimate

    SvgExportOptions:
      type: object
      properties:
        options:
          type: object
          properties:
            include_labels:
              type: boolean
              default: true
              description: Include round labels
            include_stitch_counts:
              type: boolean
              default: true
              description: Include stitch counts
            style:
              type: string
              enum:
                - wireframe
                - filled
              default: filled
              description: Visual style
            show_increases:
              type: boolean
              default: true
              description: Highlight increase stitches
            show_decreases:
              type: boolean
              default: true
              description: Highlight decrease stitches

    # Response Schemas
    GeneratePatternResponse:
      type: object
      required:
        - success
        - data
        - meta
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          required:
            - id
            - pattern
            - created_at
          properties:
            id:
              type: string
              format: uuid
              description: Pattern identifier
            pattern:
              $ref: '#/components/schemas/PatternDSL'
            created_at:
              type: string
              format: date-time
              description: Creation timestamp
            expires_at:
              type: string
              format: date-time
              description: Session expiration timestamp
              nullable: true
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    GetPatternResponse:
      type: object
      required:
        - success
        - data
        - meta
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          required:
            - id
            - pattern
            - created_at
          properties:
            id:
              type: string
              format: uuid
            pattern:
              $ref: '#/components/schemas/PatternDSL'
            created_at:
              type: string
              format: date-time
            expires_at:
              type: string
              format: date-time
              nullable: true
            time_remaining_seconds:
              type: integer
              description: Seconds until pattern expires
              nullable: true
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    ExportResponse:
      type: object
      required:
        - success
        - data
        - meta
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          required:
            - id
            - format
            - content_type
            - file_size_bytes
            - created_at
          properties:
            id:
              type: string
              description: Export identifier
            format:
              type: string
              enum:
                - pdf
                - svg
              description: Export format
            url:
              type: string
              format: uri
              description: External download URL (if applicable)
              nullable: true
            content:
              type: string
              description: Exported content (base64 for PDF, XML for SVG)
              nullable: true
            content_type:
              type: string
              enum:
                - application/pdf
                - image/svg+xml
              description: MIME type
            file_size_bytes:
              type: integer
              description: File size in bytes
            created_at:
              type: string
              format: date-time
            expires_at:
              type: string
              format: date-time
              nullable: true
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    ErrorResponse:
      type: object
      required:
        - success
        - error
        - meta
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              description: Machine-readable error code
              examples:
                - VALIDATION_ERROR
                - INVALID_GAUGE
                - PATTERN_NOT_FOUND
                - GENERATION_ERROR
                - EXPORT_ERROR
                - INTERNAL_ERROR
            message:
              type: string
              description: Human-readable error message
            details:
              type: object
              description: Additional error context
              additionalProperties: true
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    ResponseMeta:
      type: object
      required:
        - version
        - timestamp
        - request_id
      properties:
        version:
          type: string
          pattern: ^\d+\.\d+\.\d+$
          description: API/Engine version
        timestamp:
          type: string
          format: date-time
          description: Response timestamp
        request_id:
          type: string
          description: Unique request identifier

    HealthResponse:
      type: object
      required:
        - status
        - version
        - app_name
        - timestamp
      properties:
        status:
          type: string
          enum:
            - healthy
            - degraded
            - unhealthy
          description: Overall health status
        version:
          type: string
          pattern: ^\d+\.\d+\.\d+$
          description: API version
        app_name:
          type: string
          description: Application name
        timestamp:
          type: string
          format: date-time
          description: Check timestamp
        components:
          type: object
          description: Component status details
          additionalProperties:
            type: string
            enum:
              - healthy
              - degraded
              - unhealthy
          nullable: true

    PatternDSL:
      type: object
      required:
        - shape
        - gauge
        - rounds
        - metadata
      properties:
        shape:
          $ref: '#/components/schemas/ShapeParameters'
        gauge:
          $ref: '#/components/schemas/GaugeInfo'
        rounds:
          type: array
          items:
            $ref: '#/components/schemas/RoundInstruction'
          minItems: 1
          description: Round-by-round instructions
        metadata:
          $ref: '#/components/schemas/PatternMetadata'
        notes:
          type: string
          description: General pattern notes
          nullable: true

    RoundInstruction:
      type: object
      required:
        - round_number
        - stitches
        - total_stitches
      properties:
        round_number:
          type: integer
          minimum: 0
          description: Round number (0-indexed)
        stitches:
          type: array
          items:
            $ref: '#/components/schemas/StitchInstruction'
          minItems: 1
          description: Stitch instructions for this round
        total_stitches:
          type: integer
          minimum: 1
          description: Total stitch count after round
        description:
          type: string
          description: Human-readable round description
          nullable: true

    StitchInstruction:
      type: object
      required:
        - stitch_type
      properties:
        stitch_type:
          type: string
          description: Type of stitch
          examples:
            - sc
            - inc
            - dec
            - ch
            - slst
        count:
          type: integer
          minimum: 1
          default: 1
          description: Number of times to repeat
        target:
          type: string
          description: Where to place stitch
          examples:
            - next st
            - same st
            - each st
          nullable: true
        note:
          type: string
          description: Additional instruction
          nullable: true

    PatternMetadata:
      type: object
      required:
        - generated_at
        - engine_version
        - total_rounds
      properties:
        generated_at:
          type: string
          format: date-time
          description: Generation timestamp
        engine_version:
          type: string
          pattern: ^\d+\.\d+\.\d+$
          description: Pattern engine version
        total_rounds:
          type: integer
          minimum: 0
          description: Total number of rounds
        estimated_time_minutes:
          type: integer
          minimum: 0
          description: Estimated completion time
          nullable: true
        difficulty:
          type: string
          enum:
            - beginner
            - intermediate
            - advanced
          description: Difficulty level
          nullable: true
        tags:
          type: array
          items:
            type: string
          default: []
          description: Searchable tags

  responses:
    CreatedResponse:
      description: Successfully created resource
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/GeneratePatternResponse'

    OkResponse:
      description: Request successful
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/GeneratePatternResponse'

    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

tags:
  - name: Patterns
    description: Pattern generation and retrieval
  - name: Exports
    description: Pattern export to different formats
  - name: Health
    description: API health and monitoring
